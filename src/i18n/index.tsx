import { createContext, useContext, useEffect, useMemo, useState, type ReactNode } from "react";

export type AppLocale = "ko" | "en" | "ja" | "zh";

const STORAGE_KEY = "rail_ui_locale";

type Dictionary = Record<string, string>;

const MESSAGES: Record<AppLocale, Dictionary> = {
  ko: {
    "lang.ko": "한국어",
    "lang.en": "English",
    "lang.ja": "日本語",
    "lang.zh": "中文",
    "nav.workflow.short": "워크",
    "nav.workflow.title": "워크플로우",
    "nav.feed": "피드",
    "nav.bridge": "웹 연결",
    "nav.settings": "설정",
    "nav.language": "언어",
    "settings.title": "엔진 및 계정",
    "settings.engine.connected": "엔진 연결됨",
    "settings.engine.waiting": "엔진 대기",
    "settings.login.done": "로그인 완료",
    "settings.login.required": "로그인 필요",
    "settings.auth.prefix": "인증",
    "settings.cwd": "작업 경로(CWD)",
    "settings.pickFolder": "폴더 선택",
    "settings.defaultModel": "기본 모델",
    "settings.multiAgentMode": "Codex 멀티에이전트 최적화",
    "settings.engine.stop": "엔진 중지",
    "settings.engine.start": "엔진 시작",
    "settings.usage.check": "사용량 확인",
    "settings.codex.logout": "CODEX 로그아웃",
    "settings.codex.login": "CODEX 로그인",
    "settings.processing": "처리 중...",
    "settings.recentStatus": "최근 상태",
    "common.close": "닫기",
    "common.open": "열기",
    "common.save": "저장",
    "common.cancel": "취소",
    "common.delete": "삭제",
    "bridge.title": "웹 연결",
    "bridge.help.aria": "웹 연결 안내",
    "bridge.help.1": "확장과의 통신은 127.0.0.1 로컬 루프백 + Bearer 토큰으로만 허용됩니다.",
    "bridge.help.2.memory": "메모리 세션(앱 종료 시 폐기)",
    "bridge.help.2.unknown": "확인 필요",
    "bridge.help.2.prefix": "토큰 저장 위치:",
    "bridge.help.3": "실행 시 프롬프트 자동 주입/전송을 먼저 시도하며, 자동 전송 실패 시에만 웹 탭에서 전송 1회가 필요합니다.",
    "bridge.help.4": "고급 보안(선택): `RAIL_WEB_BRIDGE_ALLOWED_EXTENSION_IDS` 설정 시 등록한 확장 ID만 허용합니다.",
    "bridge.refresh.aria": "웹 연결 상태 동기화",
    "bridge.refresh.title": "웹 연결 상태 동기화",
    "bridge.ready": "웹 연결 준비됨",
    "bridge.stopped": "웹 연결 중지됨",
    "bridge.endpoint": "엔드포인트",
    "bridge.allowlist.count": "확장 ID 허용 목록 {count}개",
    "bridge.tokenMode": "토큰 보호 모드",
    "bridge.copyCode": "연결 코드 복사",
    "bridge.restart": "웹 연결 재시작",
    "bridge.rotateToken": "토큰 재발급",
    "bridge.connectCode": "연결 코드",
    "bridge.copyAgain": "다시 복사",
    "feed.title": "피드",
    "feed.filter": "필터",
    "feed.filter.status": "상태",
    "feed.filter.executor": "실행기",
    "feed.filter.period": "기간",
    "feed.filter.keyword": "키워드",
    "feed.filter.keyword.placeholder": "질문/역할/모델 검색",
    "feed.loading": "피드 로딩 중...",
    "feed.empty": "표시할 포스트가 없습니다.",
    "feed.rename": "이름 변경",
    "feed.expand": "열기",
    "feed.collapse": "닫기",
    "feed.groupName.placeholder": "세트 이름 입력",
    "feed.agent": "에이전트",
    "feed.model": "모델",
    "feed.webResultMode": "웹 결과 모드",
    "feed.webMode.bridge": "웹 연결 반자동 (권장)",
    "feed.webMode.text": "텍스트 붙여넣기",
    "feed.webMode.json": "JSON 붙여넣기",
    "feed.webTimeoutMs": "자동화 타임아웃(ms)",
    "feed.role": "역할",
    "feed.cwd": "작업 경로",
    "feed.qualityProfile": "품질 프로필",
    "feed.qualityThreshold": "통과 기준 점수",
    "feed.artifactType": "출력 아티팩트",
    "feed.outputSchema": "출력 스키마(JSON)",
    "feed.promptTemplate": "프롬프트 템플릿",
    "feed.ollamaModel": "Ollama 모델",
    "feed.ollamaPlaceholder": "예: llama3.1:8b",
    "feed.qualityCommand.enabled": "로컬 품질 명령 실행",
    "feed.qualityCommand.list": "품질 명령 목록",
    "feed.inputSources": "입력 출처",
    "feed.inputSnapshot": "전달 입력 스냅샷",
    "feed.partial": " (일부)",
    "feed.more": "더보기",
    "feed.less": "접기",
    "feed.time.generated": "생성 시간",
    "feed.usage": "사용량",
    "feed.pendingRequests": "추가 요청 대기 {count}건",
    "feed.followup.placeholder": "에이전트에게 추가 요청을 남기세요",
    "feed.followup.sending": "요청 전송 중",
    "feed.followup.send": "요청 보내기",
    "feed.copyText": "텍스트 복사",
    "feed.copyJson": "JSON 복사",
    "feed.summary.empty": "(요약 없음)",
    "feed.summary.running": "에이전트가 현재 작업 중입니다.",
    "feed.summary.failed": "실행 실패로 상세 로그 확인이 필요합니다.",
    "feed.summary.noText": "실행은 완료되었지만 표시할 결과 텍스트가 없습니다.",
    "feed.attachment.empty": "(첨부 없음)",
    "feed.post.delete": "포스트 삭제",
    "feed.agent.working": "에이전트 작업 중",
    "feed.qualityScore": "품질 점수 {score}",
    "feed.post.share": "공유하기",
    "feed.status.all": "전체",
    "feed.status.draft": "작업중",
    "feed.status.done": "완료",
    "feed.status.failed": "오류",
    "feed.status.cancelled": "취소",
    "feed.period.all": "전체",
    "feed.period.today": "오늘",
    "feed.period.7d": "최근 7일",
    "feed.executor.all": "전체",
    "feed.category.all_posts": "전체포스트",
    "feed.category.completed_posts": "완료 답변",
    "feed.category.web_posts": "웹 리서치",
    "feed.category.error_posts": "오류/취소",
    "feed.countAndDate": "{count}개 · {date}",
    "feed.liveTag": " · 실행 중",
    "modal.webInput.title": "웹 응답 입력 필요",
    "modal.node": "노드",
    "modal.service": "서비스",
    "modal.collectMode": "수집 모드",
    "modal.openServiceWindow": "서비스 창 열기",
    "modal.copyPrompt": "프롬프트 복사",
    "modal.paste": "붙여넣기",
    "modal.inputDone": "입력 완료",
    "modal.cancelRun": "실행 취소",
    "modal.loginRequired": "로그인이 필요합니다",
    "modal.openLoginSession": "로그인 세션 열기",
    "modal.continueAfterLogin": "로그인 완료 후 계속",
    "modal.approvalRequired": "승인 필요",
    "modal.requestSource": "요청 출처",
    "modal.method": "메서드",
    "modal.requestId": "요청 ID",
    "fancy.empty": "항목이 없습니다.",
    "fancy.placeholder": "선택",
    "label.node.turn": "응답 에이전트",
    "label.node.internal": "내부 처리",
    "label.node.transform": "데이터 변환",
    "label.node.gate": "결정 분기",
    "label.status.idle": "대기",
    "label.status.queued": "대기열",
    "label.status.running": "실행 중",
    "label.status.waiting_user": "사용자 입력 대기",
    "label.status.done": "완료",
    "label.status.failed": "오류",
    "label.status.skipped": "건너뜀",
    "label.status.cancelled": "정지",
    "label.knowledge.ready": "준비됨",
    "label.knowledge.missing": "파일 없음",
    "label.knowledge.unsupported": "미지원",
    "label.knowledge.error": "오류",
    "label.knowledge.unknown": "미확인",
    "label.approval.accept": "허용",
    "label.approval.acceptForSession": "세션 동안 허용",
    "label.approval.decline": "거절",
    "label.approval.cancel": "취소",
    "label.auth.chatgpt": "챗지피티",
    "label.auth.apikey": "API 키",
    "label.auth.unknown": "미확인",
    "option.multi.off": "끄기",
    "option.multi.balanced": "균형 (권장)",
    "option.multi.max": "최고 품질",
    "option.cost.conservative": "고사양 (품질 우선)",
    "option.cost.balanced": "보통 (기본)",
    "option.cost.aggressive": "저사양 (사용량 절감)",
    "option.quality.code_implementation": "코드 구현",
    "option.quality.research_evidence": "자료/근거 검증",
    "option.quality.design_planning": "설계/기획",
    "option.quality.synthesis_final": "최종 종합",
    "option.quality.generic": "일반",
    "option.artifact.none": "사용 안 함",
    "option.artifact.requirement": "요구사항 아티팩트",
    "option.artifact.design": "설계 아티팩트",
    "option.artifact.taskPlan": "작업계획 아티팩트",
    "option.artifact.changePlan": "변경계획 아티팩트",
    "option.artifact.evidence": "근거 아티팩트",
    "preset.validation": "정밀 검증 템플릿",
    "preset.development": "개발 실행 템플릿",
    "preset.research": "근거 리서치 템플릿",
    "preset.expert": "전문가 분석 템플릿",
    "preset.unityGame": "유니티 게임개발 템플릿",
    "preset.fullstack": "풀스택 구현 템플릿",
    "preset.creative": "창의 제작 템플릿",
    "preset.newsTrend": "뉴스 트렌드 템플릿",
    "preset.stock": "주식 분석 템플릿",
    "common.none": "(없음)",
    "group.custom": "사용자 정의",
    "option.knowledge.short": "짧게 (빠름)",
    "option.knowledge.normal": "보통 (균형)",
    "option.knowledge.long": "길게 (정밀)",
    "option.knowledge.xlong": "아주 길게 (최대)",
    "feed.liveLogs": "실시간 작업 로그",
    "feed.live.waitingQueue": "실행 대기 중입니다.",
    "feed.live.waitingInput": "사용자 입력 또는 후속 작업을 기다리는 중입니다.",
    "feed.source.userQuestion": "사용자 입력 질문",
    "time.justNow": "방금",
    "time.minutesAgo": "{value}분 전",
    "time.hoursAgo": "{value}시간 전",
    "time.daysAgo": "{value}일 전",
  },
  en: {
    "lang.ko": "Korean",
    "lang.en": "English",
    "lang.ja": "Japanese",
    "lang.zh": "Chinese",
    "nav.workflow.short": "Flow",
    "nav.workflow.title": "Workflow",
    "nav.feed": "Feed",
    "nav.bridge": "Web Connect",
    "nav.settings": "Settings",
    "nav.language": "Language",
    "settings.title": "Engine & Account",
    "settings.engine.connected": "Engine Connected",
    "settings.engine.waiting": "Engine Idle",
    "settings.login.done": "Logged In",
    "settings.login.required": "Login Required",
    "settings.auth.prefix": "Auth",
    "settings.cwd": "Working Directory (CWD)",
    "settings.pickFolder": "Choose Folder",
    "settings.defaultModel": "Default Model",
    "settings.multiAgentMode": "Codex Multi-Agent Optimization",
    "settings.engine.stop": "Stop Engine",
    "settings.engine.start": "Start Engine",
    "settings.usage.check": "Check Usage",
    "settings.codex.logout": "CODEX Logout",
    "settings.codex.login": "CODEX Login",
    "settings.processing": "Processing...",
    "settings.recentStatus": "Recent Status",
    "common.close": "Close",
    "common.open": "Open",
    "common.save": "Save",
    "common.cancel": "Cancel",
    "common.delete": "Delete",
    "bridge.title": "Web Connect",
    "bridge.help.aria": "Web connect help",
    "bridge.help.1": "Extension traffic is allowed only via 127.0.0.1 loopback + Bearer token.",
    "bridge.help.2.memory": "Memory session (cleared when app closes)",
    "bridge.help.2.unknown": "Unknown",
    "bridge.help.2.prefix": "Token storage:",
    "bridge.help.3": "On run, prompt auto-fill/send is attempted first. Only on auto-send failure, one manual send in the web tab is required.",
    "bridge.help.4": "Advanced security (optional): set `RAIL_WEB_BRIDGE_ALLOWED_EXTENSION_IDS` to allow only registered extension IDs.",
    "bridge.refresh.aria": "Sync web connect status",
    "bridge.refresh.title": "Sync web connect status",
    "bridge.ready": "Web Connect Ready",
    "bridge.stopped": "Web Connect Stopped",
    "bridge.endpoint": "Endpoint",
    "bridge.allowlist.count": "Extension ID allowlist: {count}",
    "bridge.tokenMode": "Token Protection Mode",
    "bridge.copyCode": "Copy Connect Code",
    "bridge.restart": "Restart Web Connect",
    "bridge.rotateToken": "Rotate Token",
    "bridge.connectCode": "Connect Code",
    "bridge.copyAgain": "Copy Again",
    "feed.title": "Feed",
    "feed.filter": "Filter",
    "feed.filter.status": "Status",
    "feed.filter.executor": "Executor",
    "feed.filter.period": "Period",
    "feed.filter.keyword": "Keyword",
    "feed.filter.keyword.placeholder": "Search question/role/model",
    "feed.loading": "Loading feed...",
    "feed.empty": "No posts to display.",
    "feed.rename": "Rename",
    "feed.expand": "Open",
    "feed.collapse": "Close",
    "feed.groupName.placeholder": "Enter group name",
    "feed.agent": "Agent",
    "feed.model": "Model",
    "feed.webResultMode": "Web Result Mode",
    "feed.webMode.bridge": "Web Assist (Recommended)",
    "feed.webMode.text": "Paste Text",
    "feed.webMode.json": "Paste JSON",
    "feed.webTimeoutMs": "Automation Timeout (ms)",
    "feed.role": "Role",
    "feed.cwd": "Working Directory",
    "feed.qualityProfile": "Quality Profile",
    "feed.qualityThreshold": "Pass Threshold",
    "feed.artifactType": "Output Artifact",
    "feed.outputSchema": "Output Schema (JSON)",
    "feed.promptTemplate": "Prompt Template",
    "feed.ollamaModel": "Ollama Model",
    "feed.ollamaPlaceholder": "e.g. llama3.1:8b",
    "feed.qualityCommand.enabled": "Run Local Quality Command",
    "feed.qualityCommand.list": "Quality Command List",
    "feed.inputSources": "Input Sources",
    "feed.inputSnapshot": "Input Snapshot",
    "feed.partial": " (partial)",
    "feed.more": "More",
    "feed.less": "Less",
    "feed.time.generated": "Duration",
    "feed.usage": "Usage",
    "feed.pendingRequests": "Pending follow-ups {count}",
    "feed.followup.placeholder": "Leave a follow-up request for the agent",
    "feed.followup.sending": "Sending request",
    "feed.followup.send": "Send request",
    "feed.copyText": "Copy Text",
    "feed.copyJson": "Copy JSON",
    "feed.summary.empty": "(No summary)",
    "feed.summary.running": "The agent is currently working.",
    "feed.summary.failed": "Execution failed. Check detailed logs.",
    "feed.summary.noText": "Execution completed, but no result text is available.",
    "feed.attachment.empty": "(No attachment)",
    "feed.post.delete": "Delete post",
    "feed.agent.working": "Agent is working",
    "feed.qualityScore": "Quality score {score}",
    "feed.post.share": "Share",
    "feed.status.all": "All",
    "feed.status.draft": "In Progress",
    "feed.status.done": "Done",
    "feed.status.failed": "Error",
    "feed.status.cancelled": "Cancelled",
    "feed.period.all": "All",
    "feed.period.today": "Today",
    "feed.period.7d": "Last 7 days",
    "feed.executor.all": "All",
    "feed.category.all_posts": "All Posts",
    "feed.category.completed_posts": "Completed",
    "feed.category.web_posts": "Web Research",
    "feed.category.error_posts": "Error/Cancelled",
    "feed.countAndDate": "{count} posts · {date}",
    "feed.liveTag": " · Running",
    "modal.webInput.title": "Web response required",
    "modal.node": "Node",
    "modal.service": "Service",
    "modal.collectMode": "Capture mode",
    "modal.openServiceWindow": "Open Service Window",
    "modal.copyPrompt": "Copy Prompt",
    "modal.paste": "Paste",
    "modal.inputDone": "Submit",
    "modal.cancelRun": "Cancel Run",
    "modal.loginRequired": "Login required",
    "modal.openLoginSession": "Open login session",
    "modal.continueAfterLogin": "Continue after login",
    "modal.approvalRequired": "Approval required",
    "modal.requestSource": "Request source",
    "modal.method": "Method",
    "modal.requestId": "Request ID",
    "fancy.empty": "No items.",
    "fancy.placeholder": "Select",
    "label.node.turn": "Response Agent",
    "label.node.internal": "Internal",
    "label.node.transform": "Transform",
    "label.node.gate": "Decision Gate",
    "label.status.idle": "Idle",
    "label.status.queued": "Queued",
    "label.status.running": "Running",
    "label.status.waiting_user": "Waiting User",
    "label.status.done": "Done",
    "label.status.failed": "Error",
    "label.status.skipped": "Skipped",
    "label.status.cancelled": "Stopped",
    "label.knowledge.ready": "Ready",
    "label.knowledge.missing": "Missing",
    "label.knowledge.unsupported": "Unsupported",
    "label.knowledge.error": "Error",
    "label.knowledge.unknown": "Unknown",
    "label.approval.accept": "Allow",
    "label.approval.acceptForSession": "Allow for session",
    "label.approval.decline": "Decline",
    "label.approval.cancel": "Cancel",
    "label.auth.chatgpt": "ChatGPT",
    "label.auth.apikey": "API Key",
    "label.auth.unknown": "Unknown",
    "option.multi.off": "Off",
    "option.multi.balanced": "Balanced (Recommended)",
    "option.multi.max": "Max Quality",
    "option.cost.conservative": "High Spec (Quality First)",
    "option.cost.balanced": "Balanced (Default)",
    "option.cost.aggressive": "Low Spec (Save Usage)",
    "option.quality.code_implementation": "Code Implementation",
    "option.quality.research_evidence": "Research/Evidence",
    "option.quality.design_planning": "Design/Planning",
    "option.quality.synthesis_final": "Final Synthesis",
    "option.quality.generic": "General",
    "option.artifact.none": "No Artifact",
    "option.artifact.requirement": "Requirement Artifact",
    "option.artifact.design": "Design Artifact",
    "option.artifact.taskPlan": "Task Plan Artifact",
    "option.artifact.changePlan": "Change Plan Artifact",
    "option.artifact.evidence": "Evidence Artifact",
    "preset.validation": "Validation Template",
    "preset.development": "Development Template",
    "preset.research": "Research Template",
    "preset.expert": "Expert Analysis Template",
    "preset.unityGame": "Unity Game Dev Template",
    "preset.fullstack": "Fullstack Template",
    "preset.creative": "Creative Template",
    "preset.newsTrend": "News Trend Template",
    "preset.stock": "Stock Analysis Template",
    "common.none": "(None)",
    "group.custom": "Custom",
    "option.knowledge.short": "Short (Fast)",
    "option.knowledge.normal": "Normal (Balanced)",
    "option.knowledge.long": "Long (Precise)",
    "option.knowledge.xlong": "Very Long (Max)",
    "feed.liveLogs": "Live run logs",
    "feed.live.waitingQueue": "Queued for execution.",
    "feed.live.waitingInput": "Waiting for user input or follow-up.",
    "feed.source.userQuestion": "User question",
    "time.justNow": "Just now",
    "time.minutesAgo": "{value}m ago",
    "time.hoursAgo": "{value}h ago",
    "time.daysAgo": "{value}d ago",
  },
  ja: {
    "lang.ko": "韓国語",
    "lang.en": "英語",
    "lang.ja": "日本語",
    "lang.zh": "中国語",
    "nav.workflow.short": "フロー",
    "nav.workflow.title": "ワークフロー",
    "nav.feed": "フィード",
    "nav.bridge": "Web連携",
    "nav.settings": "設定",
    "nav.language": "言語",
    "settings.title": "エンジンとアカウント",
    "settings.engine.connected": "エンジン接続済み",
    "settings.engine.waiting": "エンジン待機",
    "settings.login.done": "ログイン完了",
    "settings.login.required": "ログインが必要",
    "settings.auth.prefix": "認証",
    "settings.cwd": "作業パス (CWD)",
    "settings.pickFolder": "フォルダ選択",
    "settings.defaultModel": "既定モデル",
    "settings.multiAgentMode": "Codex マルチエージェント最適化",
    "settings.engine.stop": "エンジン停止",
    "settings.engine.start": "エンジン開始",
    "settings.usage.check": "使用量確認",
    "settings.codex.logout": "CODEX ログアウト",
    "settings.codex.login": "CODEX ログイン",
    "settings.processing": "処理中...",
    "settings.recentStatus": "最新状態",
    "common.close": "閉じる",
    "common.open": "開く",
    "common.save": "保存",
    "common.cancel": "キャンセル",
    "common.delete": "削除",
    "bridge.title": "Web連携",
    "bridge.help.aria": "Web連携ガイド",
    "bridge.help.1": "拡張との通信は 127.0.0.1 ループバック + Bearer トークンのみ許可されます。",
    "bridge.help.2.memory": "メモリセッション（アプリ終了時に破棄）",
    "bridge.help.2.unknown": "確認が必要",
    "bridge.help.2.prefix": "トークン保存先:",
    "bridge.help.3": "実行時はまずプロンプト自動入力/送信を試行し、自動送信失敗時のみWebタブで1回送信が必要です。",
    "bridge.help.4": "高度なセキュリティ（任意）: `RAIL_WEB_BRIDGE_ALLOWED_EXTENSION_IDS` を設定すると登録した拡張IDのみ許可します。",
    "bridge.refresh.aria": "Web連携状態を同期",
    "bridge.refresh.title": "Web連携状態を同期",
    "bridge.ready": "Web連携準備完了",
    "bridge.stopped": "Web連携停止",
    "bridge.endpoint": "エンドポイント",
    "bridge.allowlist.count": "拡張ID許可リスト {count}個",
    "bridge.tokenMode": "トークン保護モード",
    "bridge.copyCode": "接続コードをコピー",
    "bridge.restart": "Web連携を再起動",
    "bridge.rotateToken": "トークン再発行",
    "bridge.connectCode": "接続コード",
    "bridge.copyAgain": "再コピー",
    "feed.title": "フィード",
    "feed.filter": "フィルター",
    "feed.filter.status": "状態",
    "feed.filter.executor": "実行器",
    "feed.filter.period": "期間",
    "feed.filter.keyword": "キーワード",
    "feed.filter.keyword.placeholder": "質問/役割/モデル検索",
    "feed.loading": "フィードを読み込み中...",
    "feed.empty": "表示する投稿がありません。",
    "feed.rename": "名前変更",
    "feed.expand": "開く",
    "feed.collapse": "閉じる",
    "feed.groupName.placeholder": "セット名を入力",
    "modal.webInput.title": "Web応答の入力が必要です",
    "modal.node": "ノード",
    "modal.service": "サービス",
    "modal.collectMode": "収集モード",
    "modal.openServiceWindow": "サービス画面を開く",
    "modal.copyPrompt": "プロンプトコピー",
    "modal.paste": "貼り付け",
    "modal.inputDone": "入力完了",
    "modal.cancelRun": "実行取消",
    "modal.loginRequired": "ログインが必要です",
    "modal.openLoginSession": "ログインセッションを開く",
    "modal.continueAfterLogin": "ログイン後に続行",
    "modal.approvalRequired": "承認が必要",
    "modal.requestSource": "要求元",
    "modal.method": "メソッド",
    "modal.requestId": "要求ID",
    "fancy.empty": "項目がありません。",
    "fancy.placeholder": "選択",
    "label.node.turn": "応答エージェント",
    "label.node.internal": "内部処理",
    "label.node.transform": "データ変換",
    "label.node.gate": "判定分岐",
    "label.status.idle": "待機",
    "label.status.queued": "キュー",
    "label.status.running": "実行中",
    "label.status.waiting_user": "入力待ち",
    "label.status.done": "完了",
    "label.status.failed": "エラー",
    "label.status.skipped": "スキップ",
    "label.status.cancelled": "停止",
    "label.approval.accept": "許可",
    "label.approval.acceptForSession": "このセッションのみ許可",
    "label.approval.decline": "拒否",
    "label.approval.cancel": "キャンセル",
    "label.auth.chatgpt": "ChatGPT",
    "label.auth.apikey": "APIキー",
    "label.auth.unknown": "未確認",
    "option.multi.off": "オフ",
    "option.multi.balanced": "バランス（推奨）",
    "option.multi.max": "最高品質",
    "option.cost.conservative": "高性能（品質優先）",
    "option.cost.balanced": "標準（既定）",
    "option.cost.aggressive": "低負荷（使用量節約）",
    "option.quality.code_implementation": "コード実装",
    "option.quality.research_evidence": "資料/根拠検証",
    "option.quality.design_planning": "設計/企画",
    "option.quality.synthesis_final": "最終統合",
    "option.quality.generic": "一般",
    "option.artifact.none": "使用しない",
    "option.artifact.requirement": "要件アーティファクト",
    "option.artifact.design": "設計アーティファクト",
    "option.artifact.taskPlan": "作業計画アーティファクト",
    "option.artifact.changePlan": "変更計画アーティファクト",
    "option.artifact.evidence": "根拠アーティファクト",
    "preset.validation": "精密検証テンプレート",
    "preset.development": "開発実行テンプレート",
    "preset.research": "根拠リサーチテンプレート",
    "preset.expert": "専門家分析テンプレート",
    "preset.unityGame": "Unityゲーム開発テンプレート",
    "preset.fullstack": "フルスタック実装テンプレート",
    "preset.creative": "クリエイティブ制作テンプレート",
    "preset.newsTrend": "ニューストレンドテンプレート",
    "preset.stock": "株式分析テンプレート",
    "common.none": "(なし)",
    "group.custom": "カスタム",
    "option.knowledge.short": "短め（高速）",
    "option.knowledge.normal": "標準（バランス）",
    "option.knowledge.long": "長め（高精度）",
    "option.knowledge.xlong": "最長（最大）",
    "feed.liveLogs": "リアルタイム実行ログ",
    "feed.live.waitingQueue": "実行待機中です。",
    "feed.live.waitingInput": "ユーザー入力または後続処理を待機中です。",
    "feed.source.userQuestion": "ユーザー入力の質問",
    "time.justNow": "たった今",
    "time.minutesAgo": "{value}分前",
    "time.hoursAgo": "{value}時間前",
    "time.daysAgo": "{value}日前",
  },
  zh: {
    "lang.ko": "韩语",
    "lang.en": "英语",
    "lang.ja": "日语",
    "lang.zh": "中文",
    "nav.workflow.short": "流程",
    "nav.workflow.title": "工作流",
    "nav.feed": "动态",
    "nav.bridge": "网页连接",
    "nav.settings": "设置",
    "nav.language": "语言",
    "settings.title": "引擎与账号",
    "settings.engine.connected": "引擎已连接",
    "settings.engine.waiting": "引擎待机",
    "settings.login.done": "已登录",
    "settings.login.required": "需要登录",
    "settings.auth.prefix": "认证",
    "settings.cwd": "工作目录 (CWD)",
    "settings.pickFolder": "选择文件夹",
    "settings.defaultModel": "默认模型",
    "settings.multiAgentMode": "Codex 多代理优化",
    "settings.engine.stop": "停止引擎",
    "settings.engine.start": "启动引擎",
    "settings.usage.check": "查看用量",
    "settings.codex.logout": "CODEX 登出",
    "settings.codex.login": "CODEX 登录",
    "settings.processing": "处理中...",
    "settings.recentStatus": "最近状态",
    "common.close": "关闭",
    "common.open": "打开",
    "common.save": "保存",
    "common.cancel": "取消",
    "common.delete": "删除",
    "bridge.title": "网页连接",
    "bridge.help.aria": "网页连接说明",
    "bridge.help.1": "仅允许通过 127.0.0.1 回环地址 + Bearer Token 与扩展通信。",
    "bridge.help.2.memory": "内存会话（关闭应用后清除）",
    "bridge.help.2.unknown": "待确认",
    "bridge.help.2.prefix": "令牌存储位置:",
    "bridge.help.3": "执行时先尝试自动注入/发送提示词，仅在自动发送失败时才需要在网页标签手动发送 1 次。",
    "bridge.help.4": "高级安全（可选）：设置 `RAIL_WEB_BRIDGE_ALLOWED_EXTENSION_IDS` 后仅允许指定扩展 ID。",
    "bridge.refresh.aria": "同步网页连接状态",
    "bridge.refresh.title": "同步网页连接状态",
    "bridge.ready": "网页连接就绪",
    "bridge.stopped": "网页连接已停止",
    "bridge.endpoint": "端点",
    "bridge.allowlist.count": "扩展ID白名单 {count} 个",
    "bridge.tokenMode": "令牌保护模式",
    "bridge.copyCode": "复制连接码",
    "bridge.restart": "重启网页连接",
    "bridge.rotateToken": "刷新令牌",
    "bridge.connectCode": "连接码",
    "bridge.copyAgain": "再次复制",
    "feed.title": "动态",
    "feed.filter": "筛选",
    "feed.filter.status": "状态",
    "feed.filter.executor": "执行器",
    "feed.filter.period": "时间范围",
    "feed.filter.keyword": "关键词",
    "feed.filter.keyword.placeholder": "搜索问题/角色/模型",
    "feed.loading": "动态加载中...",
    "feed.empty": "暂无可显示内容。",
    "feed.rename": "重命名",
    "feed.expand": "展开",
    "feed.collapse": "收起",
    "feed.groupName.placeholder": "输入分组名称",
    "modal.webInput.title": "需要输入网页响应",
    "modal.node": "节点",
    "modal.service": "服务",
    "modal.collectMode": "采集模式",
    "modal.openServiceWindow": "打开服务窗口",
    "modal.copyPrompt": "复制提示词",
    "modal.paste": "粘贴",
    "modal.inputDone": "提交",
    "modal.cancelRun": "取消执行",
    "modal.loginRequired": "需要登录",
    "modal.openLoginSession": "打开登录会话",
    "modal.continueAfterLogin": "登录后继续",
    "modal.approvalRequired": "需要审批",
    "modal.requestSource": "请求来源",
    "modal.method": "方法",
    "modal.requestId": "请求ID",
    "fancy.empty": "暂无选项。",
    "fancy.placeholder": "选择",
    "label.node.turn": "响应代理",
    "label.node.internal": "内部处理",
    "label.node.transform": "数据转换",
    "label.node.gate": "决策分支",
    "label.status.idle": "待机",
    "label.status.queued": "排队中",
    "label.status.running": "运行中",
    "label.status.waiting_user": "等待用户输入",
    "label.status.done": "完成",
    "label.status.failed": "错误",
    "label.status.skipped": "已跳过",
    "label.status.cancelled": "已停止",
    "label.approval.accept": "允许",
    "label.approval.acceptForSession": "本会话允许",
    "label.approval.decline": "拒绝",
    "label.approval.cancel": "取消",
    "label.auth.chatgpt": "ChatGPT",
    "label.auth.apikey": "API 密钥",
    "label.auth.unknown": "未知",
    "option.multi.off": "关闭",
    "option.multi.balanced": "平衡（推荐）",
    "option.multi.max": "最高质量",
    "option.cost.conservative": "高配置（质量优先）",
    "option.cost.balanced": "标准（默认）",
    "option.cost.aggressive": "低配置（节省用量）",
    "option.quality.code_implementation": "代码实现",
    "option.quality.research_evidence": "资料/证据验证",
    "option.quality.design_planning": "设计/规划",
    "option.quality.synthesis_final": "最终综合",
    "option.quality.generic": "通用",
    "option.artifact.none": "不使用",
    "option.artifact.requirement": "需求工件",
    "option.artifact.design": "设计工件",
    "option.artifact.taskPlan": "任务计划工件",
    "option.artifact.changePlan": "变更计划工件",
    "option.artifact.evidence": "证据工件",
    "preset.validation": "精密验证模板",
    "preset.development": "开发执行模板",
    "preset.research": "证据研究模板",
    "preset.expert": "专家分析模板",
    "preset.unityGame": "Unity 游戏开发模板",
    "preset.fullstack": "全栈实现模板",
    "preset.creative": "创意制作模板",
    "preset.newsTrend": "新闻趋势模板",
    "preset.stock": "股票分析模板",
    "common.none": "(无)",
    "group.custom": "自定义",
    "option.knowledge.short": "较短（更快）",
    "option.knowledge.normal": "标准（平衡）",
    "option.knowledge.long": "较长（更精细）",
    "option.knowledge.xlong": "超长（最大）",
    "feed.liveLogs": "实时运行日志",
    "feed.live.waitingQueue": "正在排队等待执行。",
    "feed.live.waitingInput": "正在等待用户输入或后续处理。",
    "feed.source.userQuestion": "用户输入问题",
    "time.justNow": "刚刚",
    "time.minutesAgo": "{value}分钟前",
    "time.hoursAgo": "{value}小时前",
    "time.daysAgo": "{value}天前",
  },
};

const PHRASE_TO_KEY: Record<string, string> = {
  전체: "feed.status.all",
  작업중: "feed.status.draft",
  완료: "feed.status.done",
  오류: "feed.status.failed",
  취소: "feed.status.cancelled",
  오늘: "feed.period.today",
  "최근 7일": "feed.period.7d",
  "웹 연결 반자동 (권장)": "feed.webMode.bridge",
  "텍스트 붙여넣기": "feed.webMode.text",
  "JSON 붙여넣기": "feed.webMode.json",
  "항목이 없습니다.": "fancy.empty",
  선택: "fancy.placeholder",
  "데이터 변환": "label.node.transform",
  "결정 분기": "label.node.gate",
  "응답 에이전트": "label.node.turn",
  "내부 처리": "label.node.internal",
  "끄기": "option.multi.off",
  "균형 (권장)": "option.multi.balanced",
  "최고 품질": "option.multi.max",
  "고사양 (품질 우선)": "option.cost.conservative",
  "보통 (기본)": "option.cost.balanced",
  "저사양 (사용량 절감)": "option.cost.aggressive",
  "코드 구현": "option.quality.code_implementation",
  "자료/근거 검증": "option.quality.research_evidence",
  "설계/기획": "option.quality.design_planning",
  "최종 종합": "option.quality.synthesis_final",
  "일반": "option.quality.generic",
  "사용 안 함": "option.artifact.none",
  "요구사항 아티팩트": "option.artifact.requirement",
  "설계 아티팩트": "option.artifact.design",
  "작업계획 아티팩트": "option.artifact.taskPlan",
  "변경계획 아티팩트": "option.artifact.changePlan",
  "근거 아티팩트": "option.artifact.evidence",
  "정밀 검증 템플릿": "preset.validation",
  "개발 실행 템플릿": "preset.development",
  "근거 리서치 템플릿": "preset.research",
  "전문가 분석 템플릿": "preset.expert",
  "유니티 게임개발 템플릿": "preset.unityGame",
  "풀스택 구현 템플릿": "preset.fullstack",
  "창의 제작 템플릿": "preset.creative",
  "뉴스 트렌드 템플릿": "preset.newsTrend",
  "주식 분석 템플릿": "preset.stock",
  "(없음)": "common.none",
  "짧게 (빠름)": "option.knowledge.short",
  "보통 (균형)": "option.knowledge.normal",
  "길게 (정밀)": "option.knowledge.long",
  "아주 길게 (최대)": "option.knowledge.xlong",
  대기: "label.status.idle",
  대기열: "label.status.queued",
  "실행 중": "label.status.running",
  "사용자 입력 대기": "label.status.waiting_user",
  건너뜀: "label.status.skipped",
  정지: "label.status.cancelled",
};

let currentLocale: AppLocale = "ko";
const localeWatchers = new Set<(locale: AppLocale) => void>();

function renderTemplate(input: string, vars?: Record<string, string | number>): string {
  if (!vars) {
    return input;
  }
  return input.replace(/\{(\w+)\}/g, (_, key: string) => {
    const row = vars[key];
    return row == null ? "" : String(row);
  });
}

export function getCurrentLocale(): AppLocale {
  return currentLocale;
}

export function setCurrentLocale(locale: AppLocale) {
  currentLocale = locale;
  for (const watcher of localeWatchers) {
    watcher(locale);
  }
}

export function onLocaleChange(watcher: (locale: AppLocale) => void): () => void {
  localeWatchers.add(watcher);
  return () => {
    localeWatchers.delete(watcher);
  };
}

export function t(key: string, vars?: Record<string, string | number>, locale = currentLocale): string {
  const dict = MESSAGES[locale] ?? MESSAGES.ko;
  const base = dict[key] ?? MESSAGES.en[key] ?? MESSAGES.ko[key] ?? key;
  return renderTemplate(base, vars);
}

export function tp(phraseKo: string, vars?: Record<string, string | number>, locale = currentLocale): string {
  if (locale === "ko") {
    return renderTemplate(phraseKo, vars);
  }
  const points = phraseKo.match(/^(\d+)점$/);
  if (points) {
    if (locale === "en") {
      return `${points[1]} pts`;
    }
    if (locale === "ja") {
      return `${points[1]}点`;
    }
    return `${points[1]}分`;
  }
  const count = phraseKo.match(/^(\d+)개$/);
  if (count) {
    if (locale === "en") {
      return `${count[1]} items`;
    }
    if (locale === "ja") {
      return `${count[1]}件`;
    }
    return `${count[1]}项`;
  }
  const key = PHRASE_TO_KEY[phraseKo];
  if (!key) {
    return renderTemplate(phraseKo, vars);
  }
  return t(key, vars, locale);
}

type I18nContextValue = {
  locale: AppLocale;
  setLocale: (locale: AppLocale) => void;
  cycleLocale: () => void;
  t: (key: string, vars?: Record<string, string | number>) => string;
  tp: (phraseKo: string, vars?: Record<string, string | number>) => string;
};

const I18nContext = createContext<I18nContextValue>({
  locale: "ko",
  setLocale: () => {},
  cycleLocale: () => {},
  t: (key, vars) => t(key, vars, "ko"),
  tp: (phrase, vars) => renderTemplate(phrase, vars),
});

const LOCALE_ORDER: AppLocale[] = ["ko", "en", "ja", "zh"];

function normalizeLocale(input: unknown): AppLocale {
  if (input === "ko" || input === "en" || input === "ja" || input === "zh") {
    return input;
  }
  return "ko";
}

export function I18nProvider({ children }: { children: ReactNode }) {
  const [locale, setLocaleState] = useState<AppLocale>(() => {
    try {
      return normalizeLocale(window.localStorage.getItem(STORAGE_KEY));
    } catch {
      return "ko";
    }
  });

  useEffect(() => {
    setCurrentLocale(locale);
    try {
      window.localStorage.setItem(STORAGE_KEY, locale);
    } catch {
      // ignore
    }
  }, [locale]);

  const value = useMemo<I18nContextValue>(
    () => ({
      locale,
      setLocale: (next) => setLocaleState(normalizeLocale(next)),
      cycleLocale: () => {
        setLocaleState((prev) => LOCALE_ORDER[(LOCALE_ORDER.indexOf(prev) + 1) % LOCALE_ORDER.length]);
      },
      t: (key, vars) => t(key, vars, locale),
      tp: (phrase, vars) => tp(phrase, vars, locale),
    }),
    [locale],
  );

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n(): I18nContextValue {
  return useContext(I18nContext);
}

export function localeShortLabel(locale: AppLocale): string {
  if (locale === "ko") {
    return "KO";
  }
  if (locale === "en") {
    return "EN";
  }
  if (locale === "ja") {
    return "JA";
  }
  return "ZH";
}
